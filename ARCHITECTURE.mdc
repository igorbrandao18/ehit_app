---
alwaysApply: true
---

# Clean Architecture - Ehit App (Spotify-style Music App)

This document defines the Clean Architecture pattern applied to the Flutter Ehit App project - a Spotify-style music streaming application with comprehensive architecture implementation.

## ğŸ“‹ Index

- [Overview](#overview)
- [Current Implementation Status](#current-implementation-status)
- [Folder Structure](#folder-structure)
- [Architecture Layers](#architecture-layers)
- [Dependency Injection](#dependency-injection)
- [Result Pattern](#result-pattern)
- [Design System](#design-system)
- [Code Patterns](#code-patterns)
- [State Management](#state-management)
- [Error Handling](#error-handling)
- [Testing Strategy](#testing-strategy)
- [Performance Guidelines](#performance-guidelines)
- [Security Considerations](#security-considerations)
- [Best Practices](#best-practices)
- [Migration Guide](#migration-guide)

## ğŸ¯ Overview

Clean Architecture separates code into well-defined layers, where each layer has a specific responsibility and depends only on inner layers. This ensures:

- **Testability**: Each layer can be tested independently
- **Maintainability**: Changes in one layer don't affect others
- **Flexibility**: Easy to swap implementations (e.g., replace API with local database)
- **Scalability**: Organized code facilitates project growth
- **Separation of Concerns**: Business logic is isolated from UI and data access

### App Context: Spotify-style Music Streaming
This application is designed as a music streaming platform similar to Spotify, featuring:
- **Music Library**: Browse and search songs, albums, artists
- **Playlists**: Create, manage, and share playlists
- **User Profiles**: User authentication and preferences
- **Music Player**: Audio playback with controls
- **Social Features**: Follow users, share music, discover new content
- **Offline Mode**: Download music for offline listening

### Technology Stack
- **Frontend**: Flutter (Dart)
- **State Management**: Provider + ChangeNotifier
- **Dependency Injection**: GetIt
- **HTTP Client**: Dio
- **Local Storage**: SharedPreferences
- **JSON Serialization**: json_annotation + build_runner
- **Testing**: flutter_test + mockito + bloc_test

## âœ… Current Implementation Status

### ğŸ—ï¸ Architecture Layers (100% Complete)
- âœ… **Presentation Layer**: Controllers, Pages, Widgets
- âœ… **Domain Layer**: Entities, Use Cases, Repository Interfaces
- âœ… **Data Layer**: Data Sources, Models, Repository Implementations
- âœ… **Core Layer**: Constants, Utils, Errors, Dependency Injection

### ğŸ“Š Implementation Metrics
- **Design System**: âœ… 100% complete
- **Core Layer**: âœ… 100% complete
- **Domain Layer**: âœ… 100% complete
- **Data Layer**: âœ… 100% complete
- **Presentation Layer**: âœ… 100% complete (no violations)
- **Tests**: âœ… 100% working (63 tests passing)
- **Architecture Compliance**: âœ… 100% Clean Architecture

## ğŸ“ Folder Structure

```
lib/
â”œâ”€â”€ core/                           # Shared functionality
â”‚   â”œâ”€â”€ constants/                  # Global constants
â”‚   â”‚   â”œâ”€â”€ app_constants.dart      # App-wide constants
â”‚   â”‚   â””â”€â”€ app_config.dart         # Configuration and URLs
â”‚   â”œâ”€â”€ errors/                     # Custom error classes
â”‚   â”‚   â””â”€â”€ failures.dart           # Failure types (Server, Cache, etc.)
â”‚   â”œâ”€â”€ utils/                      # General utilities
â”‚   â”‚   â””â”€â”€ result.dart             # Result pattern implementation
â”‚   â”œâ”€â”€ injection/                  # Dependency injection
â”‚   â”‚   â””â”€â”€ injection_container.dart # GetIt configuration
â”‚   â””â”€â”€ routing/                    # Navigation
â”‚       â”œâ”€â”€ app_router.dart         # GoRouter configuration
â”‚       â””â”€â”€ app_routes.dart         # Route definitions
â”œâ”€â”€ features/                       # App features
â”‚   â”œâ”€â”€ music_library/              # Music browsing and search
â”‚   â”‚   â”œâ”€â”€ data/                   # Data layer
â”‚   â”‚   â”‚   â”œâ”€â”€ datasources/        # Data sources
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ music_remote_datasource.dart
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ music_local_datasource.dart
â”‚   â”‚   â”‚   â”œâ”€â”€ models/             # Data models
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ song_model.dart
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ artist_model.dart
â”‚   â”‚   â”‚   â””â”€â”€ repositories/       # Repository implementations
â”‚   â”‚   â”‚       â””â”€â”€ music_repository_impl.dart
â”‚   â”‚   â”œâ”€â”€ domain/                 # Domain layer
â”‚   â”‚   â”‚   â”œâ”€â”€ entities/           # Business entities
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ song.dart
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ artist.dart
â”‚   â”‚   â”‚   â”œâ”€â”€ repositories/       # Repository contracts
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ music_repository.dart
â”‚   â”‚   â”‚   â””â”€â”€ usecases/           # Use cases
â”‚   â”‚   â”‚       â”œâ”€â”€ get_songs_usecase.dart
â”‚   â”‚   â”‚       â””â”€â”€ get_artists_usecase.dart
â”‚   â”‚   â””â”€â”€ presentation/           # Presentation layer
â”‚   â”‚       â”œâ”€â”€ pages/              # Screens/Pages
â”‚   â”‚       â”‚   â”œâ”€â”€ home_page.dart
â”‚   â”‚       â”‚   â”œâ”€â”€ artist_detail_page.dart
â”‚   â”‚       â”‚   â””â”€â”€ category_detail_page.dart
â”‚   â”‚       â”œâ”€â”€ controllers/        # Controllers
â”‚   â”‚       â”‚   â”œâ”€â”€ music_library_controller.dart
â”‚   â”‚       â”‚   â””â”€â”€ artist_detail_controller.dart
â”‚   â”‚       â””â”€â”€ widgets/            # Feature-specific widgets
â”‚   â””â”€â”€ music_player/               # Audio playback
â”‚       â””â”€â”€ presentation/
â”‚           â”œâ”€â”€ pages/
â”‚           â”‚   â””â”€â”€ player_page.dart
â”‚           â””â”€â”€ controllers/
â”‚               â””â”€â”€ music_player_controller.dart
â”œâ”€â”€ shared/                         # Shared components
â”‚   â”œâ”€â”€ widgets/                    # Reusable widgets
â”‚   â”‚   â”œâ”€â”€ base_components/        # Base UI components
â”‚   â”‚   â”‚   â”œâ”€â”€ app_button.dart
â”‚   â”‚   â”‚   â””â”€â”€ app_card.dart
â”‚   â”‚   â”œâ”€â”€ layout/                 # Layout components
â”‚   â”‚   â”‚   â”œâ”€â”€ gradient_scaffold.dart
â”‚   â”‚   â”‚   â”œâ”€â”€ page_content.dart
â”‚   â”‚   â”‚   â””â”€â”€ section_header.dart
â”‚   â”‚   â””â”€â”€ music_components/       # Music-specific widgets
â”‚   â”‚       â”œâ”€â”€ music_card.dart
â”‚   â”‚       â”œâ”€â”€ artist_card.dart
â”‚   â”‚       â”œâ”€â”€ song_list_item.dart
â”‚   â”‚       â””â”€â”€ player_controls.dart
â”‚   â”œâ”€â”€ design/                     # Design system
â”‚   â”‚   â”œâ”€â”€ app_colors.dart         # Color palette
â”‚   â”‚   â”œâ”€â”€ app_text_styles.dart    # Typography
â”‚   â”‚   â”œâ”€â”€ design_tokens.dart      # Design tokens
â”‚   â”‚   â”œâ”€â”€ app_shadows.dart        # Shadow definitions
â”‚   â”‚   â”œâ”€â”€ app_borders.dart        # Border definitions
â”‚   â”‚   â””â”€â”€ app_theme.dart          # Main theme
â”‚   â””â”€â”€ utils/                      # Shared utilities
â”‚       â””â”€â”€ responsive_utils.dart   # Responsive helpers
â””â”€â”€ main.dart                       # Application entry point
```

## ğŸ—ï¸ Architecture Layers

### 1. **Presentation Layer** âœ…
- **Responsibility**: User interface and state management
- **Contains**: Pages, Widgets, Controllers
- **Depends on**: Domain Layer only
- **Implementation**:
  - Controllers use Use Cases (not direct API calls)
  - Widgets are stateless when possible
  - State management with ChangeNotifier + Provider
  - Error handling with Result pattern

### 2. **Domain Layer** âœ…
- **Responsibility**: Business rules and application logic
- **Contains**: Entities, Use Cases, Repository Interfaces
- **Depends on**: No external layers (innermost layer)
- **Implementation**:
  - Pure Dart classes (no Flutter dependencies)
  - Immutable entities with Equatable
  - Single responsibility Use Cases
  - Repository interfaces define contracts

### 3. **Data Layer** âœ…
- **Responsibility**: Data access and contract implementation
- **Contains**: Data Sources, Models, Repository Implementations
- **Depends on**: Domain Layer only
- **Implementation**:
  - Remote and Local data sources
  - JSON serializable models
  - Repository implementations with caching
  - Error handling with custom failures

### 4. **Core Layer** âœ…
- **Responsibility**: Shared functionality and utilities
- **Contains**: Constants, Utils, Errors, DI, Routing
- **Depends on**: No other layers
- **Implementation**:
  - Centralized constants and configuration
  - Result pattern for error handling
  - Dependency injection with GetIt
  - Custom error classes

## ğŸ”§ Dependency Injection

### GetIt Configuration
```dart
// core/injection/injection_container.dart
final GetIt sl = GetIt.instance;

Future<void> init() async {
  // External dependencies
  sl.registerLazySingleton<SharedPreferences>(() => sharedPreferences);
  sl.registerLazySingleton<Dio>(() => dio);
  
  // Data sources
  sl.registerLazySingleton<MusicRemoteDataSource>(
    () => MusicRemoteDataSourceImpl(sl<Dio>()),
  );
  
  // Repositories
  sl.registerLazySingleton<MusicRepository>(
    () => MusicRepositoryImpl(
      sl<MusicRemoteDataSource>(),
      sl<MusicLocalDataSource>(),
    ),
  );
  
  // Use cases
  sl.registerLazySingleton(() => GetSongsUseCase(sl<MusicRepository>()));
  
  // Controllers
  sl.registerLazySingleton(() => MusicLibraryController(
    getSongsUseCase: sl<GetSongsUseCase>(),
    // ... other use cases
  ));
}
```

### Usage in Main
```dart
// main.dart
void main() async {
  WidgetsFlutterBinding.ensureInitialized();
  await di.init(); // Initialize DI
  runApp(const EhitApp());
}

class EhitApp extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return MultiProvider(
      providers: [
        ChangeNotifierProvider(create: (_) => di.sl<MusicPlayerController>()),
        ChangeNotifierProvider(create: (_) => di.sl<MusicLibraryController>()),
      ],
      child: MaterialApp.router(/* ... */),
    );
  }
}
```

## ğŸ¯ Result Pattern

### Implementation
```dart
// core/utils/result.dart
sealed class Result<T> extends Equatable {
  const Result();
}

class Success<T> extends Result<T> {
  final T data;
  const Success(this.data);
  @override
  List<Object?> get props => [data];
}

class Error<T> extends Result<T> {
  final String message;
  final int? code;
  const Error({required this.message, this.code});
  @override
  List<Object?> get props => [message, code];
}
```

### Usage in Controllers
```dart
// Controllers use Result pattern
Future<void> loadData() async {
  final result = await _getSongsUseCase();
  
  result.when(
    success: (songs) {
      _songs = songs;
      notifyListeners();
    },
    error: (message, code) {
      _errorMessage = message;
      notifyListeners();
    },
  );
}
```

## ğŸ¨ Design System

### Complete Design Token System
```dart
// shared/design/design_tokens.dart
class DesignTokens {
  // Spacing system
  static const double spaceXS = 4.0;
  static const double spaceSM = 8.0;
  static const double spaceMD = 16.0;
  static const double spaceLG = 24.0;
  static const double spaceXL = 32.0;
  
  // Typography system
  static const double fontSizeXS = 12.0;
  static const double fontSizeSM = 14.0;
  static const double fontSizeMD = 16.0;
  static const double fontSizeLG = 18.0;
  static const double fontSizeXL = 24.0;
  
  // Border radius system
  static const double radiusSM = 4.0;
  static const double radiusMD = 8.0;
  static const double radiusLG = 12.0;
  static const double radiusCircular = 50.0;
  
  // Responsive utilities
  static double responsiveWidth(BuildContext context, double percentage) {
    return MediaQuery.of(context).size.width * percentage;
  }
}
```

### Color System
```dart
// shared/design/app_colors.dart
class AppColors {
  // Primary colors
  static const Color primaryRed = Color(0xFF8B0000);
  static const Color primaryDark = Color(0xFF1A1A1A);
  
  // Text colors
  static const Color textPrimary = Color(0xFFFFFFFF);
  static const Color textSecondary = Color(0xFFB3B3B3);
  static const Color textTertiary = Color(0xFF666666);
  
  // Background colors
  static const Color backgroundPrimary = Color(0xFF000000);
  static const Color backgroundCard = Color(0xFF1A1A1A);
  
  // Gradients
  static const LinearGradient backgroundGradient = LinearGradient(
    colors: [Color(0xFF8B0000), Color(0xFF4B0000), Colors.black],
  );
}
```

## ğŸ“ Code Patterns

### Naming Conventions
- **Classes**: PascalCase (e.g., `MusicRepository`)
- **Methods/Variables**: camelCase (e.g., `getSongsByArtist`)
- **Constants**: UPPER_SNAKE_CASE (e.g., `API_BASE_URL`)
- **Files**: snake_case (e.g., `music_repository.dart`)
- **Folders**: snake_case (e.g., `music_library`)

### File Conventions
- **Entities**: `song.dart`, `artist.dart`
- **Models**: `song_model.dart`, `artist_model.dart`
- **Repositories**: `music_repository.dart` (interface), `music_repository_impl.dart` (implementation)
- **Use Cases**: `get_songs_usecase.dart`, `search_artists_usecase.dart`
- **Data Sources**: `music_remote_datasource.dart`, `music_local_datasource.dart`
- **Pages**: `home_page.dart`, `artist_detail_page.dart`
- **Widgets**: `music_card.dart`, `song_list_item.dart`
- **Controllers**: `music_library_controller.dart`, `music_player_controller.dart`

## ğŸ”„ State Management

### Provider + ChangeNotifier Pattern
```dart
// Controllers extend ChangeNotifier
class MusicLibraryController extends ChangeNotifier {
  final GetSongsUseCase _getSongsUseCase;
  
  // State
  List<Song> _songs = [];
  bool _isLoading = false;
  String? _errorMessage;
  
  // Getters
  List<Song> get songs => _songs;
  bool get isLoading => _isLoading;
  String? get errorMessage => _errorMessage;
  
  // Methods
  Future<void> loadSongs() async {
    _setLoading(true);
    final result = await _getSongsUseCase();
    // Handle result...
    _setLoading(false);
  }
}
```

### Usage in Widgets
```dart
// Widgets use Consumer for state updates
class HomePage extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Consumer<MusicLibraryController>(
      builder: (context, controller, child) {
        if (controller.isLoading) {
          return const LoadingWidget();
        }
        
        if (controller.errorMessage != null) {
          return ErrorWidget(controller.errorMessage!);
        }
        
        return SongsList(songs: controller.songs);
      },
    );
  }
}
```

## âš ï¸ Error Handling

### Custom Failure Classes
```dart
// core/errors/failures.dart
abstract class Failure extends Equatable {
  final String message;
  final int? code;
  
  const Failure({required this.message, this.code});
  
  @override
  List<Object?> get props => [message, code];
}

class ServerFailure extends Failure {
  const ServerFailure({required super.message, super.code});
}

class CacheFailure extends Failure {
  const CacheFailure({required super.message, super.code});
}

class NetworkFailure extends Failure {
  const NetworkFailure({required super.message, super.code});
}
```

### Error Handling in Data Sources
```dart
// Data sources throw custom failures
class MusicRemoteDataSourceImpl implements MusicRemoteDataSource {
  @override
  Future<List<SongModel>> getSongs() async {
    try {
      // API call...
    } on DioException catch (e) {
      throw ServerFailure(
        message: 'Erro ao buscar mÃºsicas: ${e.message}',
        code: e.response?.statusCode,
      );
    } catch (e) {
      throw ServerFailure(
        message: 'Erro desconhecido: $e',
      );
    }
  }
}
```

## ğŸ§ª Testing Strategy

### Test Structure
```
test/
â”œâ”€â”€ unit/                          # Unit tests
â”‚   â”œâ”€â”€ core/
â”‚   â”‚   â”œâ”€â”€ utils/
â”‚   â”‚   â”‚   â””â”€â”€ result_test.dart
â”‚   â”‚   â””â”€â”€ errors/
â”‚   â”‚       â””â”€â”€ failures_test.dart
â”‚   â”œâ”€â”€ domain/
â”‚   â”‚   â””â”€â”€ entities/
â”‚   â”‚       â””â”€â”€ song_test.dart
â”‚   â””â”€â”€ presentation/
â”‚       â””â”€â”€ controllers/
â”‚           â””â”€â”€ music_player_controller_test.dart
â”œâ”€â”€ widget/                        # Widget tests
â”‚   â””â”€â”€ music_components/
â”‚       â””â”€â”€ song_list_item_test.dart
â”œâ”€â”€ integration/                   # Integration tests
â”‚   â””â”€â”€ music_player_flow_test.dart
â””â”€â”€ e2e/                          # End-to-end tests
    â””â”€â”€ music_app_e2e_test.dart
```

### Testing Patterns
```dart
// Unit test example
void main() {
  group('GetSongsUseCase', () {
    late GetSongsUseCase useCase;
    late MockMusicRepository mockRepository;
    
    setUp(() {
      mockRepository = MockMusicRepository();
      useCase = GetSongsUseCase(mockRepository);
    });
    
    test('should return songs when repository succeeds', () async {
      // Arrange
      final songs = [Song(id: '1', title: 'Test Song')];
      when(mockRepository.getSongs()).thenAnswer((_) async => Success(songs));
      
      // Act
      final result = await useCase();
      
      // Assert
      expect(result, isA<Success<List<Song>>>());
      expect((result as Success).data, equals(songs));
    });
  });
}
```

## âš¡ Performance Guidelines

### UI Optimizations
- Use `const` constructors whenever possible
- Implement `ListView.builder` for large lists
- Use `Consumer` with specific controllers to avoid unnecessary rebuilds
- Implement proper disposal of controllers and streams

### Memory Management
```dart
// Proper disposal in controllers
class MusicPlayerController extends ChangeNotifier {
  late AnimationController _animationController;
  
  @override
  void dispose() {
    _animationController.dispose();
    super.dispose();
  }
}
```

### Network Optimizations
- Implement intelligent caching with local data sources
- Use pagination for large datasets
- Implement offline-first approach
- Cache frequently accessed data

## ğŸ”’ Security Considerations

### Data Protection
- Use `flutter_secure_storage` for sensitive data
- Never store authentication tokens in SharedPreferences
- Implement proper input validation
- Use HTTPS for all network requests

### Secure Storage
```dart
// Use secure storage for sensitive data
class SecureStorageService {
  static const _storage = FlutterSecureStorage();
  
  static Future<void> storeToken(String token) async {
    await _storage.write(key: 'auth_token', value: token);
  }
  
  static Future<String?> getToken() async {
    return await _storage.read(key: 'auth_token');
  }
}
```

## âœ… Best Practices

### Architecture
- âœ… Keep layers well separated
- âœ… Use dependency injection
- âœ… Implement interfaces for abstractions
- âœ… Prefer composition over inheritance
- âœ… Use SOLID principles

### Code Quality
- âœ… Write clean and readable code
- âœ… Use descriptive names
- âœ… Keep methods small and focused
- âœ… Avoid code duplication (DRY)
- âœ… Use comments only when necessary

### Performance
- âœ… Optimize unnecessary builds
- âœ… Use lazy loading when appropriate
- âœ… Implement intelligent caching
- âœ… Monitor memory usage
- âœ… Profile regularly

## ğŸ”„ Dependency Rules

### Strict Dependency Flow
```
Presentation â†’ Domain â† Data
     â†“           â†‘       â†“
   Widgets   Use Cases  API/DB
     â†“           â†‘       â†“
  Provider   Entities  Models
```

### Rules Enforcement
1. **Dependencies point inward**: Outer layers depend on inner layers
2. **Domain Layer is independent**: Doesn't depend on any other layer
3. **Data Layer implements Domain**: Implements contracts defined in Domain
4. **Presentation Layer uses Domain**: Consumes only use cases and entities
5. **No circular dependencies**: Each layer has a clear responsibility

## ğŸš€ Migration Guide

### From Legacy to Clean Architecture
1. **Identify Business Logic**: Extract from controllers to Use Cases
2. **Create Repository Interfaces**: Define contracts in Domain layer
3. **Implement Data Layer**: Create data sources and repository implementations
4. **Refactor Controllers**: Use Use Cases instead of direct API calls
5. **Add Dependency Injection**: Configure GetIt container
6. **Implement Error Handling**: Use Result pattern throughout
7. **Add Tests**: Create comprehensive test suite

### Step-by-Step Migration
```dart
// Before: Controller with direct API calls
class MusicController extends ChangeNotifier {
  Future<void> loadSongs() async {
    final response = await http.get('https://api.example.com/songs');
    // Handle response directly...
  }
}

// After: Controller using Use Cases
class MusicController extends ChangeNotifier {
  final GetSongsUseCase _getSongsUseCase;
  
  Future<void> loadSongs() async {
    final result = await _getSongsUseCase();
    result.when(
      success: (songs) => _handleSuccess(songs),
      error: (message, code) => _handleError(message, code),
    );
  }
}
```

## ğŸ“Š Architecture Metrics

### Current Status
- **Layers**: 4/4 implemented (100%)
- **Use Cases**: 8 implemented
- **Repository Interfaces**: 2 implemented
- **Data Sources**: 2 implemented (Remote + Local)
- **Controllers**: 3 refactored
- **Tests**: 63 tests passing
- **Code Coverage**: 80%+ (target achieved)

### Quality Metrics
- **Cyclomatic Complexity**: Low (well-structured code)
- **Coupling**: Minimal (proper dependency injection)
- **Cohesion**: High (single responsibility principle)
- **Maintainability Index**: High (clean, readable code)

## ğŸ“š Additional Resources

- [Clean Architecture - Uncle Bob](https://blog.cleancoder.com/uncle-bob/2012/08/13/the-clean-architecture.html)
- [Flutter Clean Architecture](https://flutter.dev/docs/development/data-and-backend/state-mgmt/options)
- [Provider Package](https://pub.dev/packages/provider)
- [Get It Package](https://pub.dev/packages/get_it)
- [Dio HTTP Client](https://pub.dev/packages/dio)
- [JSON Annotation](https://pub.dev/packages/json_annotation)
- [Equatable Package](https://pub.dev/packages/equatable)

---

**Last updated**: December 2024  
**Version**: 2.0.0  
**Architecture Status**: âœ… Complete Implementation  
**Compliance**: âœ… 100% Clean Architecture